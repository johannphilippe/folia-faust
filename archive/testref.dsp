import("stdfaust.lib");

reflectionL( 1 ) =  0.0149375 , 0.38558612286040056 ;
reflectionL( 2 ) =  0.024 , 0.3077609757527541 ;
reflectionL( 3 ) =  0.02475 , 0.36521359923219143 ;
reflectionL( 4 ) =  0.0248125 , 0.11989550060923887 ;
reflectionL( 5 ) =  0.0308125 , 0.41403754743981597 ;
reflectionL( 6 ) =  0.030875 , 0.15371374134256174 ;
reflectionL( 7 ) =  0.0314375 , 0.12138069614239741 ;
reflectionL( 8 ) =  0.0363125 , 0.18243836904183328 ;
reflectionL( 9 ) =  0.0414375 , 0.17887633237837214 ;
reflectionL( 10 ) =  0.044 , 0.18039516243578302 ;
reflectionL( 11 ) =  0.0451875 , 0.23233150093495386 ;
reflectionL( 12 ) =  0.04525 , 0.13839663134014976 ;
reflectionL( 13 ) =  0.045625 , 0.17392857693480396 ;
reflectionL( 14 ) =  0.049 , 0.18589720568376017 ;
reflectionL( 15 ) =  0.0490625 , 0.14518512083279767 ;
reflectionL( 16 ) =  0.052875 , 0.14103590796428225 ;
reflectionL( 17 ) =  0.054875 , 0.13787348135358 ;
reflectionL( 18 ) =  0.0558125 , 0.1257867991113101 ;
reflectionL( 19 ) =  0.055875 , 0.15001739293682143 ;
reflectionL( 20 ) =  0.056125 , 0.11566288609983076 ;
reflectionL( 21 ) =  0.0561875 , 0.14803087116249852 ;
reflectionL( 22 ) =  0.0589375 , 0.29164979065005675 ;
reflectionL( 23 ) =  0.0649375 , 0.10042377410433304 ;
reflectionL( 24 ) =  0.0665625 , 0.15626978468460478 ;
reflectionL( 25 ) =  0.067375 , 0.15526285149704283 ;
reflectionL( 26 ) =  0.0701875 , 0.10957260955513243 ;
reflectionL( 27 ) =  0.0724375 , 0.10880220970861268 ;
reflectionL( 28 ) =  0.0726875 , 0.10025703784569631 ;
reflectionL( 29 ) =  0.0748125 , 0.20903990218470386 ;
reflectionL( 30 ) =  0.0815625 , 0.11929693484898123 ;
reflectionL( 31 ) =  0.0836875 , 0.11566806339361041 ;
reflectionL( 32 ) =  0.08575 , 0.10999452449221826 ;
reflectionL( 33 ) =  0.08775 , 0.10542430448068217 ;
reflectionL( 34 ) =  0.1074375 , 0.17626569312850407 ;
reflectionL( 35 ) =  0.1121875 , 0.16770244820834093 ;
reflectionL( 36 ) =  0.1458125 , 0.10536927129538923 ;
nreflectionsL = 36 ;

reflectionR( 1 ) =  0.0149375 , 0.3855800433638155 ;
reflectionR( 2 ) =  0.024 , 0.30770792810066705 ;
reflectionR( 3 ) =  0.02475 , 0.35700522007425284 ;
reflectionR( 4 ) =  0.0248125 , 0.11703684056685046 ;
reflectionR( 5 ) =  0.0308125 , 0.40483304851440516 ;
reflectionR( 6 ) =  0.030875 , 0.15024920774913086 ;
reflectionR( 7 ) =  0.0314375 , 0.11577732112687969 ;
reflectionR( 8 ) =  0.0363125 , 0.17441230625215617 ;
reflectionR( 9 ) =  0.0414375 , 0.18301889828753828 ;
reflectionR( 10 ) =  0.044 , 0.17592662829373762 ;
reflectionR( 11 ) =  0.0451875 , 0.23767612357405174 ;
reflectionR( 12 ) =  0.04525 , 0.14189928806986465 ;
reflectionR( 13 ) =  0.045625 , 0.17406490931867047 ;
reflectionR( 14 ) =  0.049 , 0.18584539962610536 ;
reflectionR( 15 ) =  0.0490625 , 0.14510249138623862 ;
reflectionR( 16 ) =  0.052875 , 0.14100378763128443 ;
reflectionR( 17 ) =  0.054875 , 0.14121960431579983 ;
reflectionR( 18 ) =  0.0558125 , 0.12573612247173754 ;
reflectionR( 19 ) =  0.055875 , 0.14998003753751507 ;
reflectionR( 20 ) =  0.056125 , 0.11576142967853184 ;
reflectionR( 21 ) =  0.0561875 , 0.14820303760620088 ;
reflectionR( 22 ) =  0.0589375 , 0.29208772695738305 ;
reflectionR( 23 ) =  0.0649375 , 0.10273434579504104 ;
reflectionR( 24 ) =  0.0665625 , 0.1563953783586109 ;
reflectionR( 25 ) =  0.067375 , 0.15878438772547016 ;
reflectionR( 26 ) =  0.0701875 , 0.10954529340636324 ;
reflectionR( 27 ) =  0.0724375 , 0.10903394805844438 ;
reflectionR( 28 ) =  0.0748125 , 0.20569814851634105 ;
reflectionR( 29 ) =  0.0815625 , 0.12230795840571299 ;
reflectionR( 30 ) =  0.0836875 , 0.11305291962586551 ;
reflectionR( 31 ) =  0.08575 , 0.10476963238685535 ;
reflectionR( 32 ) =  0.08775 , 0.10547491095244729 ;
reflectionR( 33 ) =  0.10075 , 0.10226378340784302 ;
reflectionR( 34 ) =  0.1074375 , 0.1785296404682651 ;
reflectionR( 35 ) =  0.1121875 , 0.16946328878438227 ;
reflectionR( 36 ) =  0.1458125 , 0.10537986076228423 ;
nreflectionsR = 36 ;

MAXSR = 48000;
MAXDEL_L = reflectionL(nreflectionsL) : _ , ! : *(MAXSR) : int;
MAXDEL_R = reflectionL(nreflectionsR) : _ , ! : *(MAXSR) : int;

delL(sig) = sum(n, nreflectionsL, apply(n+1))
with {
	apply(index) = sig : de.delay(MAXDEL_L, deltime) : *(delamp) 
	with {
		deltime = reflectionL(index) : _, !;
		delamp = reflectionL(index) : !, _;
	};
};
delR(sig) = sum(n, nreflectionsL, apply(n+1))
with {
	apply(index) = sig : de.delay(MAXDEL_R, deltime) : *(delamp) 
	with {
		deltime = reflectionR(index) : _, !;
		delamp = reflectionR(index) : !, _;
	};
};

/*
rev = re.fdnrev0(MAXDELAY, delays, BBSO, freqs, durs, loopgainmax, nonl) :> predel, predel
with {
    MAXDELAY = MAXSR;
    delays = (16, 32, 64, 128, 256, 512, 1024, 2048);
    BBSO = 5;
    freqs = (200, 400, 800, 1600);
    durs =  (0.5, 1, 1.5, 2, 3);
    loopgainmax = 0.99;
    nonl = 0;
    predel = de.delay( int(0.1 * MAXSR), int(0.1*ma.SR));
};
*/
rev = re.fdnrev0(MAXDELAY, delays, BBSO, freqs, durs, loopgainmax, nonl)
with {
    MAXDELAY = MAXSR;
    delays = (16, 32, 64, 128, 256, 512, 1024, 2048);
    BBSO = 5;
    freqs = (200, 400, 800, 1600);
    durs =  (0.5, 1, 1.5, 2, 3);
    loopgainmax = 0.99;
    nonl = 0;
};

mixdel(mix, s1, s2) = (s1 * imix) + (vl * mix), (s2 * imix) + (vr * mix)
with {
	imix = 1 - mix;
	l = s1 : delL;
	r = s2 : delR;
    verb = s1, s2 <: rev :> si.bus(2);
    vl = ba.take(1, verb);
    vr = ba.take(2, verb);
};

mix = hslider("mix", 0.3, 0, 1, 0.001);
amp = hslider("amp", 0.05, 0, 1, 0.001);
process = _ <: mixdel(mix) : *(amp), *(amp);

